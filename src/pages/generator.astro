---
import Layout from "../layouts/Layout.astro";
import { ui } from "../i18n/ui";

const locale = (Astro.locals as any).lang || 'en';
const texts = ui[locale as 'en' | 'fr'];
---

<Layout title={texts.generator.title}>
  <main data-theme="monTheme" class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 h-[calc(100vh-100px)]">

    <div class="card bg-base-200 shadow-xl p-4 flex flex-col">
      <h2 class="text-xl font-semibold mb-4">{texts.generator.title}</h2>
      <div id="svg-container" class="bg-white border rounded-lg w-full flex-1 flex items-center justify-center overflow-auto">
        <span class="text-gray-400">{texts.generator.contentPlaceholder}</span>
      </div>
    </div>

    <div class="card bg-base-200 shadow-xl p-4 flex flex-col relative h-[calc(100vh-100px)]">
      <h2 class="text-xl font-semibold mb-4">Chat</h2>

      <div id="chat-history" class="flex flex-col gap-4 w-full overflow-y-auto overflow-x-hidden flex-grow pr-2">
        <span class="text-error" id="no-history-message">{locale === 'fr' ? 'Aucun historique de chat.' : 'No chat history.'}</span>
      </div>

      <form 
        id="input-prompt-form" 
        class="flex flex-col gap-2 w-full bg-base-300 p-4"
        autocomplete="off"
      >
        <input type="hidden" id="history-hidden" value="[]" />
        <input type="hidden" id="svg-id-hidden" value="" />

        <div class="flex items-center gap-2">
          <input 
            id="prompt-input" 
            name="editPrompt" 
            type="text" 
            class="input flex-grow" 
            placeholder={texts.generator.promptLabel}
          />
          <button class="btn btn-primary" type="submit">{texts.generator.editButton}</button>
          <button id="save-button" class="btn btn-success" type="button">
            {locale === 'fr' ? 'Sauvegarder' : 'Save'}
          </button>
        </div>
      </form>
    </div>

  </main>
</Layout>

<script define:vars={{ locale, texts: ui[locale as 'en' | 'fr'].generator }}>
//@ts-nocheck

let promptList = [];

async function generateSVG(history) {
  const res = await fetch("/api/generateSVG", { 
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(history),
  });
  return await res.json();
}

function updateChat() {
  const chatHistory = document.getElementById("chat-history");
  chatHistory.innerHTML = "";

  if (promptList.length === 0) {
    const noHistoryMsg = locale === 'fr' ? 'Aucun historique de chat.' : 'No chat history.';
    chatHistory.innerHTML = `<span class="text-error">${noHistoryMsg}</span>`;
    return;
  }

  promptList.forEach(msg => {
    const wrapper = document.createElement("div");
    wrapper.className = `chat ${msg.role === "user" ? "chat-start" : "chat-end"}`;

    const bubble = document.createElement("div");
    bubble.className = `chat-bubble ${msg.role === "user" ? "bg-primary text-primary-content" : "bg-secondary text-secondary-content"}`;

    const block = document.createElement("pre");
    block.className = "whitespace-pre-wrap break-words text-xs";
    block.textContent = msg.content;
    bubble.appendChild(block);

    wrapper.appendChild(bubble);

    const footer = document.createElement("div");
    footer.className = "chat-footer opacity-60 text-xs mt-1";
    footer.textContent = msg.role;
    wrapper.appendChild(footer);

    chatHistory.appendChild(wrapper);
  });

  chatHistory.scrollTop = chatHistory.scrollHeight;
}

const form = document.getElementById("input-prompt-form");
form?.addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = new FormData(form);
  const userPrompt = formData.get("editPrompt")?.toString().trim();
  if (!userPrompt) return;

  const promptObj = { role: "user", content: userPrompt };
  promptList.push(promptObj);
  updateChat();

  const svgContainer = document.getElementById("svg-container");
  svgContainer.innerHTML = `<span class="loading loading-ring loading-xl"></span>`;

  const response = await generateSVG(promptList);
  let aiResponse = response.svg?.content || "";

  const svgMatch = aiResponse.match(/<svg[\s\S]*?<\/svg>/i);
  const svgContent = svgMatch ? svgMatch[0] : "<svg></svg>";
  svgContainer.innerHTML = svgContent;

  promptList.push({ role: "assistant", content: svgContent });
  updateChat();

  form.reset();
});

async function saveSVG(params) {
  const res = await fetch("/api/saveSVG", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(params),
  });
  return await res.json();
}

async function update(updatedData) {
  const response = await fetch("/api/updateSVG", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(updatedData),
  });
  return response.json();
}

document.getElementById("save-button")?.addEventListener("click", async () => {
  const svgOutput = document.getElementById("svg-container")?.innerHTML;
  const svgId = document.getElementById("svg-id-hidden")?.value;
  const promptMsg = locale === 'fr' 
    ? "Entrez un nom pour le SVG :" 
    : "Enter a name for the SVG:";
  const defaultName = locale === 'fr' ? "SVG sans nom" : "Unnamed SVG";
  const name = prompt(promptMsg) || defaultName;

  const params = {
    name,
    code_svg: svgOutput || "<svg></svg>",
    chat_history: promptList,
  };

  const successUpdateMsg = locale === 'fr' 
    ? `SVG mis à jour avec succès (ID: ${result.record.id})` 
    : `SVG successfully updated (ID: ${result.record.id})`;
  const errorUpdateMsg = locale === 'fr' 
    ? `Erreur lors de la mise à jour : ${result.error}` 
    : `Update error: ${result.error}`;
  const successSaveMsg = locale === 'fr' 
    ? `SVG sauvegardé avec succès (ID: ${result.id})` 
    : `SVG successfully saved (ID: ${result.id})`;
  const errorSaveMsg = locale === 'fr' 
    ? `Erreur lors de la sauvegarde : ${result.error}` 
    : `Save error: ${result.error}`;

  if (svgId) {
    params.id = svgId;
    const result = await update(params);
    if (result.success) {
      alert(successUpdateMsg);
    } else {
      alert(errorUpdateMsg);
    }
  } else {
    const result = await saveSVG(params);
    if (result.success) {
      document.getElementById("svg-id-hidden").value = result.id;
      alert(successSaveMsg);
    } else {
      alert(errorSaveMsg);
    }
  }
});
</script>