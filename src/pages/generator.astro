---
import Layout from "../layouts/Layout.astro"
---

<Layout>
  <main data-theme="monTheme" class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6">
      
    <!-- Zone saisie utilisateur -->
    <div class="card bg-base-200 shadow-xl p-4">
      <h2 class="text-xl font-semibold mb-4">Entrer un prompt</h2>
      <textarea 
        id="user-prompt" 
        class="textarea textarea-bordered w-full h-32 mb-4" 
        placeholder="Écris ton prompt ici..."></textarea>
      
      <button id="generateBtn" class="btn btn-primary w-full mb-2">Générer</button>
      <button id="edit-button" class="btn btn-secondary w-full">Edit</button>
    </div>

    <!-- Code généré -->
    <div class="card bg-base-200 shadow-xl p-4">
      <h2 class="text-xl font-semibold mb-4">Code généré</h2>
      <pre class="bg-base-100 p-4 rounded-lg overflow-x-auto h-64">
<code id="svg-output">// Le code généré apparaîtra ici</code>
      </pre>
    </div>

    <!-- Aperçu SVG -->
    <div class="card bg-base-200 shadow-xl p-4 flex flex-col items-center justify-center">
      <h2 class="text-xl font-semibold mb-4">Aperçu SVG</h2>
      <div id="svg-container" class="bg-white border rounded-lg w-full h-64 flex items-center justify-center">
        <span class="text-gray-400">[SVG affiché ici]</span>
      </div>
    </div>

  </main>
</Layout>
    

<script>
//@ts-nocheck

let promptList = []; // Historique des échanges

async function generateSVG(promptList) {
  console.log("Generating SVG for promptList:", promptList);
  const res = await fetch("/api/generateSVG", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(promptList),
  });
  const data = await res.json();
  return data; // doit contenir { role: "assistant", content: "..." }
}

// Fonction Générer
async function handleSubmit() {
  const promptElement = document.getElementById("user-prompt");
  let prompt = promptElement ? promptElement.value : "";
  console.log("Prompt soumis : ", prompt);

  // Réinitialiser la liste pour un nouveau prompt
  promptList.length = 0; 
  promptList.push({ role: "user", content: prompt });

  const svgContainer = document.getElementById("svg-container");
  svgContainer.innerHTML = `<span class="loading loading-ring loading-xl"></span>`;
  generateButton.disabled = true;

  const svgOutput = document.getElementById("svg-output");

  let aiResponse = (await generateSVG(promptList)).svg;

  const svgMatch = aiResponse.content.match(/<svg[\s\S]*?<\/svg>/i);
  aiResponse.content = svgMatch ? svgMatch[0] : "";

  promptList.push(aiResponse);

  svgOutput.textContent = aiResponse.content;
  svgContainer.innerHTML = aiResponse.content;

  generateButton.disabled = false;

  console.log("Historique des prompts : ", promptList);
}

// Fonction Edit
async function handleEdit() {
  const promptElement = document.getElementById("user-prompt");
  let prompt = promptElement ? promptElement.value : "";
  console.log("Prompt soumis pour édition : ", prompt);

  // Ajouter le prompt utilisateur à l'historique
  promptList.push({ role: "user", content: prompt });

  const svgContainer = document.getElementById("svg-container");
  svgContainer.innerHTML = `<span class="loading loading-ring loading-xl"></span>`;
  generateButton.disabled = true;
  editButton.disabled = true;

  const svgOutput = document.getElementById("svg-output");

  let aiResponse = (await generateSVG(promptList)).svg;

  const svgMatch = aiResponse.content.match(/<svg[\s\S]*?<\/svg>/i);
  aiResponse.content = svgMatch ? svgMatch[0] : "";

  promptList.push(aiResponse);

  svgOutput.textContent = aiResponse.content;
  svgContainer.innerHTML = aiResponse.content;

  generateButton.disabled = false;
  editButton.disabled = false;

  console.log("Historique des prompts : ", promptList);
}

// Event listeners
const generateButton = document.getElementById("generateBtn");
if (generateButton) {
  generateButton.addEventListener("click", handleSubmit);
}

const editButton = document.getElementById("edit-button");
if (editButton) {
  editButton.addEventListener("click", handleEdit);
}
</script>
